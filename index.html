<!DOCTYPE html>
<html>
<head>
    <title>Monk Studios Production | Lucky Wheel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --gold: #d4af37; --dark: rgba(10, 10, 10, 0.85); --neon: rgba(212, 175, 55, 0.5); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center;
            background: #000; margin: 0; min-height: 100vh; padding: 20px; overflow-x: hidden;
        }
        .bg-video-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .bg-video-wrap img { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.3) blur(4px); transform: scale(1.1); animation: bgZoom 20s infinite alternate; }
        @keyframes bgZoom { from { transform: scale(1.1); } to { transform: scale(1.2); } }

        #receipt-area { 
            display: flex; flex-direction: column; align-items: center; padding: 25px; 
            background: var(--dark); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            width: 100%; max-width: 500px; border-radius: 24px; border: 1px solid rgba(212, 175, 55, 0.2);
        }
        .insta-link { position: absolute; top: 20px; right: 20px; color: var(--gold); font-size: 1.5rem; }
        .container { position: relative; width: 75vw; height: 75vw; max-width: 380px; max-height: 380px; margin: 20px 0; border-radius: 50%; box-shadow: 0 0 30px var(--neon); }
        #wheel { width: 100%; height: 100%; border-radius: 50%; border: 6px solid #111; transition: transform 6s cubic-bezier(0.1, 0, 0.1, 1); }
        .stable-logo { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 28%; height: 28%; border-radius: 50%; border: 3px solid var(--gold); background: #000 url('image_wheel.png') center/cover; z-index: 10; }
        
        .controls { width: 100%; max-width: 400px; margin-top: 15px; display: flex; flex-direction: column; gap: 10px; }
        input { width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid var(--gold); color: #fff; border-radius: 10px; text-align: center; outline: none; }
        button { padding: 16px; font-size: 1rem; cursor: pointer; font-weight: 900; border-radius: 10px; border: none; text-transform: uppercase; letter-spacing: 2px; transition: 0.3s; }
        
        #spin-btn { background: var(--gold); color: #000; }
        #spin-btn:disabled { background: #444; color: #888; cursor: not-allowed; }
        #claim-btn { background: #25D366; color: #fff; display: none; }
        #download-btn { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid #fff; display: none; }
        
        #result { margin: 10px 0; font-size: 1.4rem; color: var(--gold); font-weight: bold; text-align: center; }
        .terms-link { font-size: 0.6rem; color: #888; text-decoration: none; margin-top: 15px; opacity: 0.7; }
    </style>
</head>
<body>

    <div class="bg-video-wrap">
        <img src="https://images.unsplash.com/photo-1598488035139-bdbb2231ce04?auto=format&fit=crop&q=80&w=2070">
    </div>

    <div id="receipt-area">
        <a href="https://www.instagram.com/monkstudiosproduction/" target="_blank" class="insta-link"><i class="fab fa-instagram"></i></a>
        <h1 style="letter-spacing: 4px; margin: 0; font-size: 1.2rem; text-align: center; color: #fff;">MONK STUDIOS PRODUCTION</h1>
        <p style="color: var(--gold); margin: 5px 0 10px 0; font-size: 0.6rem; letter-spacing: 3px; font-weight: bold;">TEAM VERIFIED EXPERIENCE</p>
        <div id="winner-name-display" style="color: #fff; font-size: 1rem; margin-bottom: 5px;"></div>

        <div class="container">
            <div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid #ff3333; z-index: 20;"></div>
            <div class="stable-logo"></div>
            <canvas id="wheel" width="800" height="800"></canvas>
        </div>

        <div id="result">READY TO SPIN</div>
        <div id="auth-stamp" style="font-size: 0.7rem; color: #777; font-family: monospace;"></div>
        <a href="terms.html" class="terms-link">Terms & Conditions Apply</a>
    </div>

    <div class="controls">
        <input type="text" id="name-input" placeholder="Artist Name">
        <input type="tel" id="phone-input" placeholder="WhatsApp Number (10 Digits)" maxlength="10">
        <button id="spin-btn">Spin to Win</button>
        <button id="claim-btn">Claim Prize via WhatsApp</button>
        <button id="download-btn">Download Digital Receipt</button>
    </div>

    <audio id="bgm-sound" src="bgm.mp3" loop></audio>
    <audio id="success-sound" src="success.wav"></audio>

    <script>
        const LOG_URL = "https://script.google.com/macros/s/AKfycbzqfPP4PaDBj7HL6TLIV0KOQVb1PpDiRp5XVbmUkfSUUFb7E7Q2iucJXhbSWkOxhvEurw/exec";
        const canvas = document.getElementById("wheel");
        const ctx = canvas.getContext("2d");
        const spinBtn = document.getElementById("spin-btn");
        const nameInput = document.getElementById("name-input");
        const phoneInput = document.getElementById("phone-input");
        const claimBtn = document.getElementById("claim-btn");
        const downloadBtn = document.getElementById("download-btn");
        const resultText = document.getElementById("result");
        const winnerDisplay = document.getElementById("winner-name-display");
        const authStamp = document.getElementById("auth-stamp");

        const bgm = document.getElementById("bgm-sound");
        const success = document.getElementById("success-sound");

        const WHATSAPP_NUMBER = "917887621520"; 
        const offers = ["10% Studio Off", "Rs. 500 Mixing Off", "Karaoke @ Rs. 400", "Cover @ Rs. 3500", "Rs. 500 3hr Off", "Rs. 200 Pre-book Off", "1hr Free Jam", "Spin Again"];
        const codes = ["10OFF", "MIX500", "KARA400", "COV3500", "3HR500", "PRE200", "JAM1HR", "TRY"];
        const colors = ["#000000", "#d4af37", "#1a1a1a", "#b8860b", "#000000", "#d4af37", "#1a1a1a", "#b8860b"];
        
        let currentRotation = 0;
        let hasSpun = false;

        function drawWheel() {
            for (let i = 0; i < 8; i++) {
                ctx.beginPath(); ctx.fillStyle = colors[i]; ctx.moveTo(400, 400);
                ctx.arc(400, 400, 400, (i*45)*Math.PI/180, ((i+1)*45)*Math.PI/180);
                ctx.fill(); ctx.save(); ctx.translate(400, 400);
                ctx.rotate((i*45 + 22.5) * Math.PI / 180);
                ctx.textAlign = "right"; ctx.fillStyle = "#fff"; ctx.font = "bold 24px Arial";
                ctx.fillText(offers[i], 370, 10); ctx.restore();
            }
        }
        drawWheel();

        spinBtn.onclick = async () => {
            const userName = nameInput.value.trim();
            const userPhone = phoneInput.value.trim();
            
            if(!userName || userPhone.length < 10) {
                alert("Please enter Name and 10-digit Phone Number!"); return;
            }
            
            spinBtn.disabled = true;
            spinBtn.innerText = "VERIFYING...";

            try {
                const response = await fetch(`${LOG_URL}?action=check&phone=${userPhone}`);
                const status = await response.text();
                if (status.includes("REJECTED")) {
                    alert("⚠️ Access Denied: You have already used your spin this month.");
                    spinBtn.innerText = "SPIN TO WIN"; spinBtn.disabled = false; return;
                }
            } catch (e) { console.log("Check failed, allowing spin."); }

            // START SPIN
            bgm.volume = 0.4; bgm.play().catch(()=>{});
            const spinDegrees = (360 * 10) + Math.floor(Math.random() * 360);
            currentRotation += spinDegrees;
            canvas.style.transform = `rotate(${currentRotation}deg)`;
            nameInput.style.display = "none"; phoneInput.style.display = "none"; spinBtn.style.visibility = "hidden";

            setTimeout(() => {
                bgm.pause();
                const winningIndex = Math.floor((360 - (currentRotation % 360) + 270) % 360 / 45);
                const winner = offers[winningIndex];
                
                if (winner === "Spin Again") {
                    resultText.innerText = "ALMOST! TRY AGAIN";
                    spinBtn.style.visibility = "visible"; spinBtn.innerText = "SPIN AGAIN"; spinBtn.disabled = false;
                    nameInput.style.display = "block"; phoneInput.style.display = "block";
                } else {
                    const timeHash = Date.now().toString().slice(-4);
                    const finalCode = `MS-${timeHash}-${codes[winningIndex]}`;
                    winnerDisplay.innerText = userName.toUpperCase();
                    resultText.innerText = winner;
                    authStamp.innerText = `ID: ${finalCode}`;
                    
                    // LOG WIN TO SHEET
                    fetch(`${LOG_URL}?action=log&name=${encodeURIComponent(userName)}&phone=${userPhone}&prize=${encodeURIComponent(winner)}&id=${finalCode}`, { mode: 'no-cors' });
                    
                    success.play().catch(()=>{});
                    confetti({ particleCount: 150, spread: 70, colors: ['#d4af37', '#ffffff'] });
                    claimBtn.style.display = "block"; downloadBtn.style.display = "block";

                    claimBtn.onclick = () => {
                        const msg = `*MONK STUDIOS PRODUCTION*\n\nName: *${userName}*\nPhone: *${userPhone}*\nPrize: *${winner}*\nID: ${finalCode}\n\nHi Team, please verify my win!`;
                        window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`);
                    };
                }
            }, 6000);
        };

        downloadBtn.onclick = () => {
            html2canvas(document.querySelector("#receipt-area"), { backgroundColor: "#000", scale: 2 }).then(canvas => {
                const link = document.createElement('a'); link.download = `Monk_Win.png`; link.href = canvas.toDataURL(); link.click();
            });
        };
    </script>
</body>
</html>
